name: OPA Scan

on: 
 issues:
  type:
   -closed
   -opened

jobs:
  security_scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Pull OPA Docker image
      run: docker pull openpolicyagent/opa:latest

    - name: Run OPA Scan
      run: |
        # Print directory contents
        ls -la

        # Run OPA against Terraform code using Docker
        docker run --rm -v $(pwd):/data openpolicyagent/opa eval -d /data/OPA_policy.rego 'data.main'

        # Capture the exit code of the OPA evaluation
        OPA_EXIT_CODE=$?

        # Check the exit code and exit accordingly
        if [ $OPA_EXIT_CODE -eq 0 ]; then
          echo "OPA scan passed successfully."
        else
          echo "OPA scan failed with policy violations."
        fi
        exit $OPA_EXIT_CODE
